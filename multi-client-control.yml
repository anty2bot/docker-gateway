---
- name: Setup multiple clients on multiple servers
  hosts: remote
  vars:
    status: "{{ status | default('on') }}"

  vars_files:
    - ~/.config/multi-client-config.yml

  tasks:
    - name: Initial Docker
      when: status == 'init'
      block:
        - name: Copy setup-docker.sh into inventory_hostname
          copy:
            src: utils/setup-docker.sh
            dest: /tmp/setup-docker.sh
          delegate_to: "{{ inventory_hostname }}"

        - name: Run setup-docker.sh
          command: >
            bash /tmp/setup-docker.sh install
          delegate_to: "{{ inventory_hostname }}"
          become: yes

        - name: Clean setup-docker.sh
          file:
            path: /tmp/setup-docker.sh
            state: absent
          delegate_to: "{{ inventory_hostname }}"

    - name: Update subscription
      when: status == 'update'
      block:
        - name: Ensure directory exists for each subscription
          file:
            path: "{{ item.dir }}"
            state: directory
            mode: '0755'
          delegate_to: localhost
          loop: "{{ subscribe }}"

        - name: Generate the local config files from URL
          command: >
            python3 ./utils/sub2json.py
            -s "{{ item.url }}"
            -o "{{ item.dir }}"
          delegate_to: localhost
          loop: "{{ subscribe }}"
          when: item.raw is not defined or item.raw | length == 0

        - name: Generate the local config files from raw
          command: >
            python3 ./utils/sub2json.py
            -r "{{ item.raw }}"
            -o "{{ item.dir }}"
          delegate_to: localhost
          loop: "{{ subscribe }}"
          when: item.raw is defined and item.raw | length > 0

    - name: Generate config file
      when: status == 'on'
      block:
        - name: Generate the config files locally
          command: >
            python3 ./utils/v2builder.py
            -i {{ item.file }}
            -o config_{{ item.country }}.json
            --allow_lan
            --http_port {{ item.port }}
          delegate_to: localhost
          loop: "{{ clusters }}"

        - name: Copy the config files into inventory_hostname
          copy:
            src: config_{{ item.country }}.json
            dest: /tmp/config_{{ item.country }}.json
          delegate_to: "{{ inventory_hostname }}"
          loop: "{{ clusters }}"

        - name: Clean the local config files
          file:
            path: config_{{ item.country }}.json
            state: absent
          delegate_to: localhost
          loop: "{{ clusters }}"

    - name: Setup multiple proxy clients
      when: status in ['on', 'off']
      block:
        - name: Check if v2fly.tar exists
          stat:
            path: v2fly.tar
          delegate_to: localhost
          register: v2fly_stat

        - name: Copy v2fly.tar inoto inventory_hostname if it exists
          copy:
            src: v2fly.tar
            dest: /tmp/v2fly.tar
          delegate_to: "{{ inventory_hostname }}"
          when: v2fly_stat.stat.exists

        - name: Check if xray.tar exists
          stat:
            path: xray.tar
          delegate_to: localhost
          register: xray_stat

        - name: Copy xray.tar inoto inventory_hostname if it exists
          copy:
            src: xray.tar
            dest: /tmp/xray.tar
          delegate_to: "{{ inventory_hostname }}"
          when: xray_stat.stat.exists

        - name: Copy sha256 files into inventory_hostname
          copy:
            src: utils/sha256/{{ item }}.sha256
            dest: /tmp/{{ item }}.sha256
          delegate_to: "{{ inventory_hostname }}"
          loop: "{{ clients }}"

        - name: Copy setup-multi-client.sh into inventory_hostname
          copy:
            src: utils/setup-multi-client.sh
            dest: /tmp/setup-multi-client.sh
          delegate_to: "{{ inventory_hostname }}"

        - name: Setup multi clients Docker if it's not ready
          command: >
            bash /tmp/setup-multi-client.sh {{ item }}
          delegate_to: "{{ inventory_hostname }}"
          loop: "{{ clients }}"
          become: yes

        - name: Assert client is in allowed clients
          assert:
            that:
              - item.client in clients
            fail_msg: "Invalid client: {{ item.client }}. Must be one of {{ clients }}."
          loop: "{{ clusters }}"
        
        - name: Run setup-multi-client.sh
          command: >
            bash /tmp/setup-multi-client.sh {{ item.client }} {{ item.country }} {{ item.port }} {{ status }} /tmp/config_{{ item.country }}.json
          delegate_to: "{{ inventory_hostname }}"
          loop: "{{ clusters }}"
          become: yes

        - name: Generate clusters info
          copy:
            dest: "~/proxy.{{ item.country }}"
            content: |
              {{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:{{ item.port }}
          delegate_to: localhost
          loop: "{{ clusters }}"

        - name: Clean setup-multi-client.sh
          file:
            path: /tmp/setup-multi-client.sh
            state: absent
          delegate_to: "{{ inventory_hostname }}"

        - name: Clean sha256 files
          file:
            path: /tmp/{{ item }}.sha256
            state: absent
          delegate_to: "{{ inventory_hostname }}"
          loop: "{{ clients }}"
